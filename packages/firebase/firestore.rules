rules_version = '2';

service cloud.firestore {
  function isSignedIn() {
    return request.auth != null;
  }

  function isAuthUser(userId) {
    return request.auth.uid == userId;
  }

  function isTeamOwner() {
    return request.auth.uid == request.resource.data.ownerId;
  }

  function isTeamAdmin(teamId) {
    return get(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)).data.role == 'admin';
  }

  function isTeamMember(teamId) {
    return get(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid));
  }
  
  match /databases/{database}/documents {
    match /{document=**} {
      match /users/{userId} {
        allow read, write: if isAuthUser(userId);
      }

      match /customers/{customerId} {
        allow read, create: if isAuthUser(customerId);
      }

      match /products/{productId} {
        allow read: if isSignedIn();
      }

      match /prices/{priceId} {
        allow read: if isSignedIn();
      }

      match /subscriptions/{subscriptionId} {
        allow read: if isAuthUser(subscriptionId);
      }

      match /teams/{teamId} {
        allow create: if isTeamOwner();
        allow write: if isTeamAdmin(teamId);
        allow read: if isTeamMember(teamId);

        match /members/{userId} {
          allow write: if isTeamAdmin(teamId); 
          allow read: if isTeamMember(teamId);
        }
      }
    }
  }
}